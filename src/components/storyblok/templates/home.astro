---
import { storyblokEditable, renderRichText } from '@storyblok/astro'
import { useStoryblokApi } from '@storyblok/astro'

import { Picture } from 'astro:assets';
const storyblokApi = useStoryblokApi();

const { data } = await storyblokApi.get('cdn/stories', {
  version: import.meta.env.DEV ? "draft" : "published",
  content_type: 'blog_post',
})

const posts = data.stories.map(story => {
  return {
    title: story.name,
    description: story.content.excerpt,
    slug: story.full_slug,
  }
})

const { blok } = Astro.props
const content = renderRichText(blok.hero_content)
const heroImage = blok?.hero_image?.filename
const heroImageDimensions = heroImage?.split('/')[5].split('x')
---
<div class="container max-w-3xl"  {...storyblokEditable(blok)}>
  <div class="flex flex-col gap-4 p-8 md:p-24">
    {heroImage && <Picture formats={['avif', 'webp']} loading="eager" src={heroImage} width={heroImageDimensions?.[0]} height={heroImageDimensions?.[1]} alt={blok?.hero_image?.alt} class="w-fit h-48 mb-8 md:mb-12" />}
    <Fragment set:html={content} />
    
    {blok?.social_links?.length >= 0 && (
      <ul class="mt-12 flex gap-4">
      {blok?.social_links?.map(({ link, title }: { link: any, title:string }, index: number) => (
        <>
          <li>
            <a href={link?.url} target={link?.target} class="social">{title}</a>
          </li>
          {index !== blok?.social_links?.length - 1 && <li>&bull;</li>}
        </>
      ))}
    </ul>
    )}
  </div>
  {posts?.length > 0 && (<div class="flex flex-col gap-4 px-8 md:px-24 pb-8 md:pb-24">
    <h2 class="text-2xl font-bold mb-4">blog posts</h2>
    {posts?.map(post => (
      <a href={post.slug} class="social">
        <p>{post.title}</p>
      </a>
    ))}
  </div>)}
</div>